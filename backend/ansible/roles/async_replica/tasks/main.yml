---
# 0. PRE-REQUISITE: INSTALL MARIADB SERVER
- name: Ensure MariaDB Server is installed on Async Node
  apt:
    name: 
      - mariadb-server
      - python3-pymysql
    state: present
    update_cache: yes
  become: yes

# 1. FIX PERMISSIONS ON THE GALERA MASTER
- name: Ensure Replication User has access from Async Node IP
  community.mysql.mysql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    host: "{{ ansible_host }}"
    priv: "*.*:REPLICATION SLAVE"
    state: present
    login_user: root
    login_password: "{{ wsrep_sst_auth.split(':')[1] }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  delegate_to: "{{ groups['galera'][0] }}"
  run_once: true
  become: yes
  register: repl_user_setup
  until: repl_user_setup is success
  retries: 20
  delay: 10

# 2. APPLY CONFIGURATION
- name: Ensure MariaDB config directory exists
  file:
    path: /etc/mysql/mariadb.conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Apply Standalone Replica Configuration
  template:
    src: replica.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/70-replica.cnf
  become: yes
  register: replica_conf

- name: Restart MariaDB to apply gtid_domain_id and server-id
  systemd:
    name: mariadb
    state: restarted
    enabled: yes
    daemon_reload: yes
  become: yes
  when: replica_conf.changed

- name: Wait for MariaDB to come back online
  wait_for:
    host: 127.0.0.1
    port: 3306
    timeout: 30
  when: replica_conf.changed

# 3. THE "NUCLEAR" RESET
- name: Hard Reset Slave State for GTID alignment
  shell: |
    mariadb -e "STOP REPLICA;"
    mariadb -e "RESET REPLICA ALL;"
    mariadb -e "RESET MASTER;"
    mariadb -e "SET GLOBAL gtid_slave_pos = '';"
  become: yes

# 4. CAPTURE MASTER POSITION
- name: Get current Master GTID Position
  shell: "mariadb -u root -p'{{ wsrep_sst_auth.split(':')[1] }}' -N -s -e 'SELECT @@gtid_binlog_pos;'"
  delegate_to: "{{ groups['galera'][0] }}"
  register: master_gtid_raw
  until: master_gtid_raw.rc == 0
  retries: 20
  delay: 10
  become: yes
  changed_when: false
  no_log: true

# 5. SYNC SLAVE TO MASTER POSITION
- name: Align Slave GTID position with Master
  shell: "mariadb -e \"SET GLOBAL gtid_slave_pos = '{{ master_gtid_raw.stdout | trim }}';\""
  become: yes
  when: master_gtid_raw.stdout | length > 0

# 6. CONFIGURE AND START
- name: Configure Master Handshake
  community.mysql.mysql_replication:
    mode: changeprimary
    primary_host: "{{ hostvars[groups['galera'][0]]['ansible_host'] }}"
    primary_user: "{{ repl_user }}"
    primary_password: "{{ repl_password }}"
    primary_use_gtid: replica_pos
    login_user: root
    login_password: "{{ wsrep_sst_auth.split(':')[1] }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  become: yes

- name: Allow Root Access on Async Node for Health Checker
  community.mysql.mysql_user:
    name: root
    host: "{{ item }}"
    password: "{{ wsrep_sst_auth.split(':')[1] }}"
    priv: "*.*:ALL,GRANT"
    state: present
    login_user: root
    login_password: "{{ wsrep_sst_auth.split(':')[1] }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  loop:
    - "%"
    - "127.0.0.1"
    - "localhost"
  become: yes

- name: Start Replication
  community.mysql.mysql_replication:
    mode: startreplica
    login_user: root
    login_password: "{{ wsrep_sst_auth.split(':')[1] }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  become: yes

# 7. FINAL VERIFICATION
- name: Verify Replication Status
  shell: "mariadb -u root -p'{{ wsrep_sst_auth.split(':')[1] }}' -e 'SHOW REPLICA STATUS\\G' | grep -E 'Slave_(IO|SQL)_Running|Seconds_Behind_Master|Last_IO_Error'"
  register: final_check
  become: yes
  changed_when: false
  until: '"Slave_IO_Running: Yes" in final_check.stdout'
  retries: 15
  delay: 5

- name: Force skip initial replication errors if any
  shell: |
    mariadb -u root -p'{{ wsrep_sst_auth.split(':')[1] }}' -e "STOP SLAVE;"
    mariadb -u root -p'{{ wsrep_sst_auth.split(':')[1] }}' -e "SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1;"
    mariadb -u root -p'{{ wsrep_sst_auth.split(':')[1] }}' -e "START SLAVE;"
  become: yes
  when: "final_check.stdout is search('Slave_SQL_Running: No')"

- name: Display Replication Status
  debug:
    var: final_check.stdout_lines
