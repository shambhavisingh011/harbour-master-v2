---
# 0. PRE-REQUISITE: INSTALL & CLUSTER READINESS
- name: Ensure MariaDB Server is installed on Async Node
  apt:
    name: 
      - mariadb-server
      - python3-pymysql
    state: present
    update_cache: yes
  become: yes

- name: Identify Healthy Galera Nodes
  shell: "mariadb -u root -p'{{ db_admin_password }}' -N -s -e \"SHOW STATUS LIKE 'wsrep_local_state_comment';\""
  become: yes
  delegate_to: "{{ item }}"
  loop: "{{ groups['galera'] }}"
  register: galera_health_results
  ignore_errors: yes
  changed_when: false
- name: Set Active Galera Master Fact (Force db-03)
  set_fact:
    # This directly picks the 3rd node in the 'galera' inventory group
    active_galera_master: "{{ groups['galera'][2] }}"
  run_once: true

- name: Check current Replication Status on Async Node
  shell: "mariadb -u root -p'{{ db_admin_password }}' -e 'SHOW REPLICA STATUS\\G'"
  register: slave_status_raw
  ignore_errors: yes
  become: yes
  changed_when: false

- name: Set Replication Health Fact
  set_fact:
    is_replication_healthy: "{{ 'Slave_IO_Running: Yes' in slave_status_raw.stdout and 'Slave_SQL_Running: Yes' in slave_status_raw.stdout }}"
  when: slave_status_raw.rc == 0

# 1. FIX PERMISSIONS ON THE GALERA MASTER
- name: Ensure Replication User has access from Async Node IP
  community.mysql.mysql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    host: "{{ ansible_host }}"
    priv: "*.*:REPLICATION SLAVE"
    state: present
    login_user: root
    login_password: "{{ db_admin_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  become: yes
  # Dynamically delegate to the node we confirmed is Synced
  delegate_to: "{{ active_galera_master }}"
  run_once: true
  when: not (is_replication_healthy | default(false))

# 2. APPLY CONFIGURATION
- name: Ensure MariaDB config directory exists
  file:
    path: /etc/mysql/mariadb.conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Apply Standalone Replica Configuration
  template:
    src: replica.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/70-replica.cnf
  become: yes
  register: replica_conf

- name: Grant Control Node access to Async Node for Diagnostics
  community.mysql.mysql_user:
    name: root
    password: "{{ db_admin_password }}"
    # Robust IP detection: Try SSH_CLIENT, then Control Node IP, then fallback to Head Node's specific subnet IP
    host: "{{ (ansible_env.SSH_CLIENT | default('')).split() | first | default(hostvars['localhost']['ansible_default_ipv4']['address'] | default('192.168.64.191')) }}"
    priv: "*.*:ALL,GRANT"
    state: present
    login_user: root
    login_password: "{{ db_admin_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes

- name: Restart MariaDB to apply configs
  systemd:
    name: mariadb
    state: restarted
  become: yes
  when: replica_conf.changed

# 3. THE "NUCLEAR" RESET
- name: Hard Reset Slave State for GTID alignment
  shell: |
    mariadb -u root -p'{{ db_admin_password }}' -e "STOP REPLICA;"
    mariadb -u root -p'{{ db_admin_password }}' -e "RESET REPLICA ALL;"
    mariadb -u root -p'{{ db_admin_password }}' -e "SET GLOBAL gtid_slave_pos = '';"
  become: yes
  when: not (is_replication_healthy | default(false))

# 4. CAPTURE MASTER POSITION
- name: Get Master GTID Position
  shell: "mariadb -u root -p'{{ db_admin_password }}' -N -s -e 'SELECT @@gtid_binlog_pos;'"
  become: yes
  delegate_to: "{{ active_galera_master }}"
  register: master_gtid
  run_once: true
  when: not (is_replication_healthy | default(false))

# 5. SYNC SLAVE POSITION
- name: Align Slave GTID position
  shell: "mariadb -u root -p'{{ db_admin_password }}' -e \"SET GLOBAL gtid_slave_pos = '{{ master_gtid.stdout | trim }}';\""
  become: yes
  when: 
    - not (is_replication_healthy | default(false))
    - master_gtid is defined and master_gtid.rc == 0

# 6. CONFIGURE AND START

- name: Configure Master Handshake
  community.mysql.mysql_replication:
    mode: changeprimary
    # Connect the slave specifically to the healthy master we found
    primary_host: "{{ hostvars[active_galera_master]['ansible_host'] }}"
    primary_user: "{{ repl_user }}"
    primary_password: "{{ repl_password }}"
    primary_use_gtid: replica_pos
    login_user: root
    login_password: "{{ db_admin_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  when: not (is_replication_healthy | default(false))

- name: Start Replication
  community.mysql.mysql_replication:
    mode: startreplica
    login_user: root
    login_password: "{{ db_admin_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  when: not (is_replication_healthy | default(false))

# 7. FINAL VERIFICATION
- name: Verify Replication Status
  shell: "mariadb -u root -p'{{ db_admin_password }}' -e 'SHOW REPLICA STATUS\\G'"
  register: final_check
  become: yes
  until: '"Slave_IO_Running: Yes" in final_check.stdout and "Slave_SQL_Running: Yes" in final_check.stdout'
  retries: 15
  delay: 10
