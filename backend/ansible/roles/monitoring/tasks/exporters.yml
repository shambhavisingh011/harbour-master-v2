---
- name: Install Node and MySQL Exporters
  apt:
    name:
      - prometheus-node-exporter
      - prometheus-mysqld-exporter
      - python3-pymysql
    state: present
    update_cache: yes
  become: yes

- name: "[Gatekeeper] Check Galera Sync Status"
  shell: |
    PASS="{{ wsrep_sst_auth.split(':')[1] }}"
    # Check if we can even talk to MariaDB first
    if ! mariadb -u root -p"$PASS" -e "status" >/dev/null 2>&1; then
        echo "OFFLINE"
    else
        STATUS=$(mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';" | awk '{print $2}')
        echo "${STATUS:-Standalone}"
    fi
  become: yes
  register: cluster_status
  # Only run on Galera nodes; Async and others skip
  when: inventory_hostname in groups['galera']
  until: cluster_status.stdout == "Synced" or cluster_status.stdout == "Standalone"
  retries: 10
  delay: 5
  ignore_errors: yes

- name: "[Recovery] Force Bootstrap on Primary Node if stuck"
  shell: |
    PASS="{{ wsrep_sst_auth.split(':')[1] }}"
    STATE=$(mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state';" | awk '{print $2}')
    if [ "$STATE" == "NON-PRIMARY" ]; then
       mariadb -u root -p"$PASS" -e "SET GLOBAL wsrep_provider_options='pc.bootstrap=YES';"
    fi
  # Dynamically target the first node of the galera group
  when: 
    - inventory_hostname == groups['galera'][0]
    - cluster_status.stdout is defined
    - cluster_status.stdout != "Synced"
    - cluster_status.stdout != "Standalone"
  ignore_errors: yes

- name: "[Gatekeeper] Final Wait for Sync after Recovery"
  shell: |
    PASS="{{ wsrep_sst_auth.split(':')[1] }}"
    mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';" | awk '{print $2}'
  become: yes
  register: final_sync_check
  until: final_sync_check.stdout == "Synced" or final_sync_check.stdout == "Standalone"
  retries: 15
  delay: 10
  when: 
    - inventory_hostname in groups['galera']
    - cluster_status.stdout is defined 
    - cluster_status.stdout != "Synced"
    - cluster_status.stdout != "Standalone"

- name: Create MariaDB Exporter User
  community.mysql.mysql_user:
    name: "exporter"
    password: "{{ exporter_password }}"
    priv: "*.*:PROCESS,REPLICATION CLIENT,SELECT"
    state: present
    column_case_sensitive: false 
    login_user: root
    login_password: "{{ wsrep_sst_auth.split(':')[1] }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  become: yes
  # Apply to Galera nodes and the Async node
  when: inventory_hostname in (groups['galera'] + groups['async'] | default([]))

- name: Configure MySQL Exporter Auth
  copy:
    dest: /etc/mysql/exporter.cnf
    owner: prometheus
    group: prometheus
    mode: '0400'
    content: |
      [client]
      user=exporter
      password={{ exporter_password }}
      host=localhost
  become: yes
  register: exporter_cfg
  when: inventory_hostname in (groups['galera'] + groups['async'] | default([]))

- name: Set MySQL Exporter Flags
  lineinfile:
    path: /etc/default/prometheus-mysqld-exporter
    regexp: '^ARGS='
    line: 'ARGS="--config.my-cnf=/etc/mysql/exporter.cnf --web.listen-address=:9104"'
  become: yes
  register: exporter_flags
  when: inventory_hostname in (groups['galera'] + groups['async'] | default([]))

- name: Restart and Enable Monitoring Agents
  systemd:
    name: "{{ item }}"
    state: restarted
    enabled: yes
    daemon_reload: yes
  become: yes
  loop:
    - prometheus-node-exporter
    - prometheus-mysqld-exporter
  when: 
    - inventory_hostname in (groups['galera'] + groups['async'] | default([]))
    - (exporter_cfg.changed or exporter_flags.changed)

- name: Ensure Node Exporter is active on non-DB nodes
  systemd:
    name: prometheus-node-exporter
    state: started
    enabled: yes
  become: yes
  when: inventory_hostname not in (groups['galera'] + groups['async'] | default([]))
