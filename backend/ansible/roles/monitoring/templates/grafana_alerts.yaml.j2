apiVersion: 1
groups:
  - orgId: 1
    name: HarborMasterAlerts
    folder: Infrastructure
    interval: 10s
    rules:
      # 1. GALERA CLUSTER SIZE
      - uid: galera_shrunk
        title: Galera Cluster Size Shrunk
        condition: C
        data:
          - refId: A
            datasourceUid: "prom_ds_phase5"
            relativeTimeRange: { from: 300, to: 0 }
            model: { expr: "max(mysql_global_status_wsrep_cluster_size{instance=~'db-.*'})" }
          - refId: B
            datasourceUid: "__expr__"
            model: { type: "reduce", expression: "A", reducer: "last", settings: { mode: "dropNN" } }
          - refId: C
            datasourceUid: "__expr__"
            model: { type: "threshold", expression: "B", conditions: [{ evaluator: { params: [3], type: "lt" }, operator: { type: "and" }, query: { params: [] }, type: "query" }] }
        for: 0s
        annotations: { summary: "Galera Cluster Shrunk", description: "Cluster size below 3 nodes. Quorum at risk!" }
        labels: { severity: critical }


      # 3. ASYNC NODE DOWN (OS Level)
      - uid: async_node_down
        title: Async Node Down
        condition: C
        data:
          - refId: A
            datasourceUid: "prom_ds_phase5"
            relativeTimeRange: { from: 60, to: 0 }
            model: { expr: "up{instance=~'.*async.*'}" }
          - refId: B
            datasourceUid: "__expr__"
            model: { type: "reduce", expression: "A", reducer: "last", settings: { mode: "dropNN" } }
          - refId: C
            datasourceUid: "__expr__"
            model: { type: "threshold", expression: "B", conditions: [{ evaluator: { params: [0], type: "eq" }, operator: { type: "and" }, query: { params: [] }, type: "query" }] }
        for: 0s
        annotations: { summary: "Async Node Offline", description: "Prometheus cannot reach the async node exporter." }
        labels: { severity: critical }

      # 4. ASYNC MARIADB STOPPED
      - uid: async_mariadb_stopped
        title: Async MariaDB Stopped
        condition: C
        data:
          - refId: A
            datasourceUid: "prom_ds_phase5"
            relativeTimeRange: { from: 60, to: 0 }
            model: { expr: "absent(mysql_version_info{instance=~'.*async.*'}) or on() vector(0)" }
          - refId: B
            datasourceUid: "__expr__"
            model: { type: "reduce", expression: "A", reducer: "last", settings: { mode: "dropNN" } }
          - refId: C
            datasourceUid: "__expr__"
            model: { type: "threshold", expression: "B", conditions: [{ evaluator: { params: [1], type: "eq" }, operator: { type: "and" }, query: { params: [] }, type: "query" }] }
        for: 0s
        annotations: { summary: "Async MariaDB Stopped", description: "MariaDB process is down on the async node." }
        labels: { severity: critical }

 
      - uid: hcip_offline
        title: HCIP_Offline
        condition: C
        data:
          - refId: A
            datasourceUid: "prom_ds_phase5"
            relativeTimeRange: { from: 60, to: 0 }
            # Filter specifically for Galera nodes to detect if the Cluster IP is missing
            model: { expr: "sum(node_network_address_info{address='10.0.0.100', instance=~'db-.*'}) or vector(0)" }
          - refId: B
            datasourceUid: "__expr__"
            model: { type: "reduce", expression: "A", reducer: "last", settings: { mode: "dropNN" } }
          - refId: C
            datasourceUid: "__expr__"
            model: { type: "threshold", expression: "B", conditions: [{ evaluator: { params: [1], type: "lt" }, operator: { type: "and" }, query: { params: [] }, type: "query" }] }
        for: 30s # Adding a small buffer to prevent false alarms during quick failovers
        annotations: { summary: "HCIP Offline", description: "The HCIP ON dummy O is missing from both DB nodes!" }
        labels: { severity: critical }

      - uid: vip_offline
        title: VIP_Offline
        condition: C
        data:
          - refId: A
            datasourceUid: "prom_ds_phase5"
            relativeTimeRange: { from: 60, to: 0 }
            # Filter specifically for LVS nodes so Galera's local VIP doesn't trick us
            model: { expr: "sum(node_network_address_info{address='{{ lvs_vip }}', instance=~'lvs-.*'}) or vector(0)" }
          - refId: B
            datasourceUid: "__expr__"
            model: { type: "reduce", expression: "A", reducer: "last", settings: { mode: "dropNN" } }
          - refId: C
            datasourceUid: "__expr__"
            model: { type: "threshold", expression: "B", conditions: [{ evaluator: { params: [1], type: "lt" }, operator: { type: "and" }, query: { params: [] }, type: "query" }] }
        for: 0s
        annotations: { summary: "VIP Offline", description: "LVS VIP is missing from all Load Balancers!" }
        labels: { severity: critical }

