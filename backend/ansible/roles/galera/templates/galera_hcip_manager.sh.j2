#!/bin/bash
HCIP="{{ hcip_value }}"
PASS="{{ wsrep_sst_auth.split(':')[1] }}"

# Cleanup function if the script itself is killed
cleanup() {
    echo "Caught signal, stripping HCIP $HCIP..."
    ip addr del $HCIP/32 dev dummy0 2>/dev/null
    exit 0
}

trap cleanup SIGINT SIGTERM

echo "Starting Continuous HCIP Manager..."

while true; do
    # 1. Check if MariaDB is even responding
    if ! mariadb -u root -p"$PASS" -e "status" >/dev/null 2>&1; then
        echo "MariaDB connection failed. Stripping HCIP..."
        ip addr del $HCIP/32 dev dummy0 2>/dev/null
    else
        # 2. If it is responding, check if it's the Primary (Index 0)
        STATE=$(mariadb -u root -p"$PASS" -rs -e "SHOW GLOBAL STATUS LIKE 'wsrep_local_state_comment';" | awk '{print $2}')
        INDEX=$(mariadb -u root -p"$PASS" -rs -e "SHOW GLOBAL STATUS LIKE 'wsrep_local_index';" | awk '{print $2}')

        if [ "$STATE" == "Synced" ] && [ "$INDEX" == "0" ]; then
            if ! ip addr show dummy0 | grep -q "$HCIP"; then
                ip addr add $HCIP/32 dev dummy0
                ip link set dummy0 up
            fi
        else
            # Not Index 0 or not Synced? Remove the IP immediately
            ip addr del $HCIP/32 dev dummy0 2>/dev/null
        fi
    fi
    sleep 2
done
