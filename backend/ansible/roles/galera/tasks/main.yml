---
# 1. Install Software & Dependencies
- name: Install MariaDB Server and Galera dependencies
  apt:
    name:
      - mariadb-server
      - mariadb-client
      - mariadb-backup
      - python3-pymysql
      - socat             # Required for Galera SST
      - rsync             # Required for Galera SST
    state: present
    update_cache: yes
  become: yes

# 2. Prevent Standalone Conflict
- name: Stop MariaDB to prevent standalone mode conflicts
  service:
    name: mariadb
    state: stopped
  become: yes

- name: Disable default bind-address in 50-server.cnf
  lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address'
    line: '#bind-address = 127.0.0.1'
  become: yes

# 3. Configure Node
- name: Deploy Galera Configuration
  template:
    src: galera.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/60-galera.cnf
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: config_deployed

# 4. Initialization & Bootstrap Preparation
- name: Initialize MariaDB data directory if empty
  command: mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
  args:
    creates: /var/lib/mysql/mysql
  become: yes

- name: Check if grastate.dat exists
  stat:
    path: /var/lib/mysql/grastate.dat
  register: grastate_file

# 5. Handle Cluster Bootstrap logic
- name: Bootstrap logic for Primary Node (Node 01)
  block:
    - name: Set safe_to_bootstrap flag in grastate.dat
      lineinfile:
        path: /var/lib/mysql/grastate.dat
        regexp: '^safe_to_bootstrap: 0'
        line: 'safe_to_bootstrap: 1'
      when: grastate_file.stat.exists
    - name: Execute Galera New Cluster command
      command: galera_new_cluster
      register: bootstrap_cluster
    - name: Wait for Primary Node to be ready
      wait_for:
        port: 3306
        timeout: 30
    - name: Create SST User for replication
      community.mysql.mysql_user:
        name: "{{ wsrep_sst_auth.split(':')[0] }}"
        password: "{{ wsrep_sst_auth.split(':')[1] }}"
        priv: "*.*:ALL"
        state: present
        host: "%"
        login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  when: inventory_hostname == groups['galera'][0]
- name: Join Secondary Nodes to Cluster
  service:
    name: mariadb
    state: started
  become: yes
  when: inventory_hostname != groups['galera'][0]
  throttle: 1  # Join one by one to prevent SST storms
  register: node_join
  until: node_join is success
  retries: 3
  delay: 5
# 6. Verification
- name: Wait for Galera nodes to reach Synced state
  shell: "mariadb -u root -e \"SHOW STATUS LIKE 'wsrep_local_state_comment';\" | grep 'Synced'"
  register: wait_for_sync
  until: wait_for_sync.rc == 0
  retries: 40
  delay: 10
  become: yes
  changed_when: false

- name: Check actual cluster size
  shell: "mariadb -u root -e \"SHOW STATUS LIKE 'wsrep_cluster_size';\" | grep -v 'Value' | awk '{print $2}'"
  register: actual_cluster_size
  failed_when: (actual_cluster_size.stdout | trim | int) < 3
  become: yes

# 7. LVS Networking & Replication
- name: Configure VIP on loopback for LVS DR mode
  shell: |
    ip addr add {{ lvs_vip }}/32 dev lo label lo:0 || true
    sysctl -w net.ipv4.conf.all.arp_ignore=1
    sysctl -w net.ipv4.conf.all.arp_announce=2
  become: yes

- name: Create Replication User for Async Node
  community.mysql.mysql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    priv: "*.*:REPLICATION SLAVE"
    host: "%"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  delegate_to: "{{ groups['galera'][0] }}"
  run_once: true
cd
- name: Allow Root Access from Remote Network
  community.mysql.mysql_user:
    name: root
    host: "{{ item }}"
    password: "{{ wsrep_sst_auth.split(':')[1] }}"
    priv: "*.*:ALL,GRANT"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  loop:
    - "%"
    - "{{ ansible_facts['default_ipv4']['address'] }}"
  become: yes
  delegate_to: "{{ groups['galera'][0] }}"

