---
# ===============================================================
# PHASE 0: DISCOVERY (Determine the Current Reality)
# ===============================================================

- name: "DISCOVERY: Audit all nodes (Pre-Flight)"
  setup:
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['galera'] }}"
  run_once: true

- name: "DISCOVERY: Check if MariaDB is installed"
  stat:
    path: /usr/sbin/mariadbd
  register: mariadb_installed

- name: "DISCOVERY: Check local Galera state"
  shell: |
    STATUS=$(mariadb -u root -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';" 2>/dev/null | awk '{print $2}')
    if [ -z "$STATUS" ]; then
      PASS="{{ wsrep_sst_auth.split(':')[1] }}"
      STATUS=$(mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';" 2>/dev/null | awk '{print $2}')
    fi
    echo "${STATUS:-OFFLINE}"
  become: yes
  register: galera_info
  changed_when: false

- name: "LOGIC: Set Discovery Facts"
  set_fact:
    is_installed: "{{ mariadb_installed.stat.exists }}"
    is_synced: "{{ 'Synced' in galera_info.stdout }}"
    # We check if ANY node in the cluster is already healthy
    cluster_is_alive: "{{ groups['galera'] | map('extract', hostvars) | selectattr('galera_info.stdout', 'defined') | selectattr('galera_info.stdout', 'search', 'Synced') | list | length > 0 }}"

# ===============================================================
# PHASE 1: PREPARATION (Install & Config)
# ===============================================================

- name: "INSTALL: MariaDB Packages"
  apt:
    name: [mariadb-server, mariadb-client, mariadb-backup, python3-pymysql, socat, rsync, keepalived]
    state: present
    update_cache: yes
  become: yes
  when: not is_installed

- name: "CONFIG: Deploy Galera Configuration"
  template:
    src: galera.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/60-galera.cnf
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: config_deployed

# ===============================================================
# PHASE 2: CLUSTER INITIALIZATION (The 2-Case Logic)
# ===============================================================

- name: "EXECUTION: Handle Cluster Start"
  block:
    - name: "STOP: Kill standalone or broken MariaDB processes"
      service:
        name: mariadb
        state: stopped

    # --- CASE A: Cluster is NOT formed (Bootstrap from Node 01) ---
    - name: "CASE A: Bootstrap Primary Node"
      block:
        - name: "Force safe_to_bootstrap"
          lineinfile:
            path: /var/lib/mysql/grastate.dat
            regexp: '^safe_to_bootstrap: 0'
            line: 'safe_to_bootstrap: 1'
        - name: "Initialize Galera New Cluster"
          command: galera_new_cluster
      when: inventory_hostname == groups['galera'][0]

    # --- CASE B: Cluster is already formed or Node 01 is up (Joining) ---
    - name: "CASE B: Join Existing Cluster"
      service:
        name: mariadb
        state: started
      when: inventory_hostname != groups['galera'][0]

  become: yes
  # This whole block ONLY runs if the node is not already synced 
  # AND no other node is already providing a healthy cluster.
  when: not is_synced and not cluster_is_alive

# ===============================================================
# PHASE 3: NETWORKING & HA
# ===============================================================

- name: "LVS-DR & HCIP Networking"
  block:
    - name: "LVS-DR: Loopback VIP"
      shell: "ip addr add {{ lvs_vip }}/32 dev lo || true"
      changed_when: false

    - name: "HCIP: Interface dummy0 Setup"
      shell: |
        modprobe dummy && ip link add dummy0 type dummy || true
        ip link set dummy0 up
      changed_when: false

    - name: "HCIP: Deploy Keepalived Files"
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "{{ item.mode }}"
      loop:
        - { src: 'galera_hcip_manager.sh.j2', dest: '/usr/local/sbin/galera_healthcheck.sh', mode: '0755' }
        - { src: 'db_keepalived.conf.j2', dest: '/etc/keepalived/keepalived.conf', mode: '0644' }
      register: ha_files

    - name: "HCIP: Ensure Keepalived service"
      service:
        name: keepalived
        state: "{{ 'restarted' if ha_files.changed else 'started' }}"
        enabled: yes
  become: yes
  when: inventory_hostname in groups['galera'][:2]

# ===============================================================
# PHASE 4: FINAL VALIDATION & USERS
# ===============================================================

- name: "WAIT: Ensure node is Synced before finishing"
  shell: |
    PASS="{{ wsrep_sst_auth.split(':')[1] }}"
    mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';"
  become: yes
  register: final_sync
  until: '"Synced" in final_sync.stdout'
  retries: 30
  delay: 10
  when: not is_synced
- name: "SSH: Authorize LVS Health Check Key"
  ansible.builtin.authorized_key:
    user: root
    state: present
    # This pulls the public key from your head-node's LVS role folder
    key: "{{ lookup('file', 'roles/lvs/files/id_rsa.pub') }}"
  become: yes

- name: "USERS: Setup Cluster Access"
  community.mysql.mysql_user:
    name: "{{ item.name }}"
    password: "{{ wsrep_sst_auth.split(':')[1] }}"
    host: "{{ item.host }}"
    priv: "*.*:ALL,GRANT"
    state: present
    login_user: root
    login_password: "{{ wsrep_sst_auth.split(':')[1] }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  loop:
    - { name: "{{ wsrep_sst_auth.split(':')[0] }}", host: "%" }
    - { name: "root", host: "%" }
    - { name: "root", host: "localhost" }
  become: yes
  run_once: true
  delegate_to: "{{ groups['galera'][0] }}"
