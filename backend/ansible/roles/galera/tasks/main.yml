---
# ===============================================================
# PHASE 0: DISCOVERY (Determine the Current Reality)
# ===============================================================

- name: "DISCOVERY: Audit all nodes (Pre-Flight)"
  setup:
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['galera'] }}"
  run_once: true

- name: "DISCOVERY: Check if MariaDB is installed"
  stat:
    path: /usr/sbin/mariadbd
  register: mariadb_installed

- name: "DISCOVERY: Check local Galera state"
  shell: |
    STATUS=$(mariadb -u root -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';" 2>/dev/null | awk '{print $2}')
    if [ -z "$STATUS" ]; then
      # CHANGED: Using db_admin_password instead of SST password
      PASS="{{ db_admin_password }}" 
      STATUS=$(mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';" 2>/dev/null | awk '{print $2}')
    fi
    echo "${STATUS:-OFFLINE}"
  become: yes
  register: galera_info
  changed_when: false

- name: "LOGIC: Set Discovery Facts"
  set_fact:
    is_installed: "{{ mariadb_installed.stat.exists }}"
    is_synced: "{{ 'Synced' in galera_info.stdout }}"
    # We check if ANY node in the cluster is already healthy
    cluster_is_alive: "{{ groups['galera'] | map('extract', hostvars) | selectattr('galera_info.stdout', 'defined') | selectattr('galera_info.stdout', 'search', 'Synced') | list | length > 0 }}"

# ===============================================================
# PHASE 1: PREPARATION (Install & Config)
# ===============================================================

- name: "INSTALL: MariaDB Packages"
  apt:
    name: [mariadb-server, mariadb-client, mariadb-backup, python3-pymysql, socat, rsync, keepalived]
    state: present
    update_cache: yes
  become: yes
  when: not is_installed

- name: "CONFIG: Deploy Galera Configuration"
  template:
    src: galera.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/60-galera.cnf
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: config_deployed

# ===============================================================
# PHASE 2: CLUSTER INITIALIZATION
# ===============================================================

- name: "STOP: Ensure MariaDB is stopped before cluster logic"
  service:
    name: mariadb
    state: stopped
  become: yes
  when: not is_synced

- name: "CASE A: Bootstrap Primary Node"
  block:
    - name: "CHECK: Check if grastate.dat exists"
      stat:
        path: /var/lib/mysql/grastate.dat
      register: grastate_file

    - name: "Force safe_to_bootstrap"
      lineinfile:
        path: /var/lib/mysql/grastate.dat
        regexp: '^safe_to_bootstrap: 0'
        line: 'safe_to_bootstrap: 1'
      when: grastate_file.stat.exists

    - name: "Initialize Galera New Cluster"
      command: galera_new_cluster
  become: yes
  # Only bootstrap if the cluster is totally dead AND I am node 1
  when: 
    - not is_synced 
    - not cluster_is_alive
    - inventory_hostname == groups['galera'][0]

- name: "CASE B: Join Existing Cluster"
  service:
    name: mariadb
    state: started
  become: yes
  # Run this if the cluster is alive OR I am not node 1
  when: 
    - not is_synced
    - (cluster_is_alive or inventory_hostname != groups['galera'][0])
# ===============================================================
# PHASE 3: NETWORKING & HA
# ===============================================================

- name: "LVS-DR & HCIP Networking"
  block:
    - name: "LVS-DR: Loopback VIP"
      shell: "ip addr add {{ lvs_vip }}/32 dev lo || true"
      changed_when: false

    - name: "HCIP: Interface dummy0 Setup"
      shell: |
        modprobe dummy && ip link add dummy0 type dummy || true
        ip link set dummy0 up
      changed_when: false

    # --- FIX 1: Install the package so the service and /etc/keepalived exist ---
    - name: "HCIP: Install Keepalived"
      apt:
        name: keepalived
        state: present
        update_cache: yes

    # --- FIX 2: Explicitly ensure the directory exists before templating ---
    - name: "HCIP: Ensure Keepalived directory exists"
      file:
        path: /etc/keepalived
        state: directory
        mode: '0755'

    - name: "HCIP: Deploy Keepalived Files"
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "{{ item.mode }}"
      loop:
        - { src: 'galera_hcip_manager.sh.j2', dest: '/usr/local/sbin/galera_healthcheck.sh', mode: '0755' }
        - { src: 'db_keepalived.conf.j2', dest: '/etc/keepalived/keepalived.conf', mode: '0644' }
      register: ha_files

    - name: "HCIP: Ensure Keepalived service"
      service:
        name: keepalived
        # Using 'restarted' logic is good, but Ensure it's 'started' if it was just installed
        state: "{{ 'restarted' if ha_files.changed else 'started' }}"
        enabled: yes
  become: yes
  when: inventory_hostname in groups['galera'][:2]

# ===============================================================
# PHASE 4: FINAL VALIDATION & USERS
# ===============================================================
- name: "WAIT: Ensure node is Synced before finishing"
  shell: |
    # CHANGED: Using db_admin_password
    PASS="{{ db_admin_password }}"
    mariadb -u root -p"$PASS" -N -s -e "SHOW STATUS LIKE 'wsrep_local_state_comment';"
  become: yes
  register: final_sync
  until: '"Synced" in final_sync.stdout'
  retries: 30
  delay: 10
  when: not is_synced

- name: "SSH: Authorize LVS Health Check Key"
  ansible.builtin.authorized_key:
    user: root
    state: present
    # This pulls the public key from your head-node's LVS role folder
    key: "{{ lookup('file', 'roles/lvs/files/id_rsa.pub') }}"
  become: yes

- name: "USERS: Setup Cluster Access"
  community.mysql.mysql_user:
    # Logic: If item.name is root, use db_admin_password; otherwise use SST password
    name: "{{ item.name }}"
    password: "{{ (item.name == 'root') | ternary(db_admin_password, wsrep_sst_auth.split(':')[1]) }}"
    host: "{{ item.host }}"
    # Logic: Give root ALL privileges, give SST user only sync privileges
    priv: "{{ (item.name == 'root') | ternary('*.*:ALL,GRANT', '*.*:RELOAD,PROCESS,LOCK TABLES,REPLICATION CLIENT') }}"
    state: present
    login_user: root
    # CHANGED: login_password is now the db_admin_password
    login_password: "{{ db_admin_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
  loop:
    - { name: "{{ wsrep_sst_auth.split(':')[0] }}", host: "%" }
    - { name: "root", host: "%" }
    - { name: "root", host: "localhost" }
  become: yes
  run_once: true
  delegate_to: "{{ groups['galera'][0] }}"

- name: "USERS: Setup Replication User for Async Node"
  community.mysql.mysql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    host: "%"
    priv: "*.*:REPLICATION SLAVE"
    state: present
    login_user: root
    login_password: "{{ db_admin_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  run_once: true
  delegate_to: "{{ groups['galera'][0] }}"

