---
# 1. Install Software & Dependencies
- name: Install MariaDB Server and Galera dependencies
  apt:
    name:
      - mariadb-server
      - mariadb-client
      - mariadb-backup
      - python3-pymysql
      - socat             # Required for Galera SST
      - rsync             # Required for Galera SST
    state: present
    update_cache: yes
  become: yes

# 2. Prevent Standalone Conflict
- name: Stop MariaDB to prevent standalone mode conflicts
  service:
    name: mariadb
    state: stopped
  become: yes

- name: Disable default bind-address in 50-server.cnf
  lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address'
    line: '#bind-address = 127.0.0.1'
  become: yes

# 3. Configure Node
- name: Deploy Galera Configuration
  template:
    src: galera.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/60-galera.cnf
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: config_deployed

# 4. Initialization & Bootstrap Preparation
- name: Initialize MariaDB data directory if empty
  command: mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
  args:
    creates: /var/lib/mysql/mysql
  become: yes

- name: Check if grastate.dat exists
  stat:
    path: /var/lib/mysql/grastate.dat
  register: grastate_file

# 5. Handle Cluster Bootstrap logic
- name: Bootstrap logic for Primary Node (Node 01)
  block:
    - name: Set safe_to_bootstrap flag in grastate.dat
      lineinfile:
        path: /var/lib/mysql/grastate.dat
        regexp: '^safe_to_bootstrap: 0'
        line: 'safe_to_bootstrap: 1'
      when: grastate_file.stat.exists

    - name: Execute Galera New Cluster command
      command: galera_new_cluster

    - name: Wait for Primary Node to be ready
      wait_for:
        port: 3306
        timeout: 60

    - name: Create SST User for replication
      community.mysql.mysql_user:
        name: "{{ wsrep_sst_auth.split(':')[0] }}"
        password: "{{ wsrep_sst_auth.split(':')[1] }}"
        priv: "*.*:ALL"
        state: present
        host: "%"
        login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  when: inventory_hostname == groups['galera'][0]

- name: Join Secondary Nodes to Cluster
  service:
    name: mariadb
    state: started
  become: yes
  when: inventory_hostname != groups['galera'][0]
  throttle: 1
  register: node_join
  until: node_join is success
  retries: 5
  delay: 10

# 6. Verification
- name: Wait for Galera nodes to reach Synced state
  shell: "mariadb -u root -e \"SHOW STATUS LIKE 'wsrep_local_state_comment';\" | grep 'Synced'"
  register: wait_for_sync
  until: wait_for_sync.rc == 0
  retries: 40
  delay: 15  # Increased delay to allow for background sync
  become: yes
  changed_when: false

# 7. SINGLE-WRITER HCIP LOGIC (The "Dummy" Setup)
- name: Ensure dummy network module is loaded
  modprobe:
    name: dummy
    state: present
  become: yes

- name: Create dummy0 network interface
  shell: "ip link add dummy0 type dummy || true"
  become: yes

- name: Deploy HCIP Management Script
  copy:
    dest: /usr/local/bin/galera_hcip_manager.sh
    mode: '0755'
    content: |
      #!/bin/bash
      # Managed by Harbor Master
      HCIP="{{ hcip_value | default('10.0.0.100') }}"
      STATE=$(mariadb -N -s -e "SHOW GLOBAL STATUS LIKE 'wsrep_local_state_comment';" | awk '{print $2}')
      INDEX=$(mariadb -N -s -e "SHOW GLOBAL STATUS LIKE 'wsrep_local_index';" | awk '{print $2}')

      if [ "$STATE" == "Synced" ] && [ "$INDEX" == "0" ]; then
          if ! ip addr show dummy0 | grep -q "$HCIP"; then
              ip addr add $HCIP/32 dev dummy0
              ip link set dummy0 up
          fi
      else
          ip addr del $HCIP/32 dev dummy0 2>/dev/null
          ip link set dummy0 down 2>/dev/null
      fi
  become: yes

- name: Run HCIP Manager to initialize state
  command: /usr/local/bin/galera_hcip_manager.sh
  become: yes

- name: Add HCIP Manager to Crontab for persistence
  cron:
    name: "Galera HCIP Monitor"
    minute: "*"
    job: "/usr/local/bin/galera_hcip_manager.sh"
  become: yes

# 8. Users & Access Management (Crucial Fix for Demo)
- name: Create Replication User for Async Node
  community.mysql.mysql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    priv: "*.*:REPLICATION SLAVE"
    host: "%"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: yes
  delegate_to: "{{ groups['galera'][0] }}"
  run_once: true
  register: create_user_repl
  until: create_user_repl is success
  retries: 10
  delay: 20

- name: Allow Root Access from Remote Network
  community.mysql.mysql_user:
    name: root
    host: "{{ item }}"
    password: "{{ wsrep_sst_auth.split(':')[1] }}"
    priv: "*.*:ALL,GRANT"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  loop:
    - "%"
    - "{{ ansible_facts['default_ipv4']['address'] }}"
  become: yes
  delegate_to: "{{ groups['galera'][0] }}"
  run_once: true
  register: root_access_repl
  until: root_access_repl is success
  retries: 10
  delay: 20
