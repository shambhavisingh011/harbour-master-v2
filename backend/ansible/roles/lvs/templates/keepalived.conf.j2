vrrp_instance VI_1 {
    state {{ 'MASTER' if inventory_hostname == groups['lvs'][0] else 'BACKUP' }}
    interface {{ ansible_default_ipv4.interface }}
    virtual_router_id 51
    priority {{ 100 if inventory_hostname == groups['lvs'][0] else 90 }}
    advert_int 1
    virtual_ipaddress {
        {{ lvs_vip }}
    }
}

virtual_server {{ lvs_vip }} 3306 {
    delay_loop 2
    lb_algo wrr
    lb_kind DR
    protocol TCP

    {% for host in groups['galera'][:2] %}
    # Using ansible_host to ensure compatibility with --limit deployments
    real_server {{ hostvars[host]['ansible_host'] }} 3306 {
        weight 100
        MISC_CHECK {
            # This script returns 0 only if {{ hcip_value }} is found on the remote dummy0
            misc_path "/usr/bin/ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /root/.ssh/id_rsa root@{{ hostvars[host]['ansible_host'] }} 'ip addr show dummy0 | grep -q {{ hcip_value }}'"
            misc_timeout 5
        }
    }
    {% endfor %}
}
