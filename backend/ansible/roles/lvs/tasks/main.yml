---
# 1. Install Keepalived and Ipvsadm
- name: Install LVS and Keepalived dependencies
  apt:
    name:
      - keepalived
      - ipvsadm
    state: present
    update_cache: yes
  become: yes

# 2. Enable IP Forwarding
- name: Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  become: yes

# 3. Setup SSH for Health Checks
- name: Ensure .ssh directory exists for root
  file:
    path: /root/.ssh
    state: directory
    mode: '0700'
  become: yes

- name: Deploy SSH Private Key for LVS Health Checks
  copy:
    src: id_rsa  
    dest: /root/.ssh/id_rsa
    owner: root
    group: root
    mode: '0600'
  become: yes

# 4. Deploy Health Check Script
# FIX: Using 'template' style or escaping the $1 is better to prevent Ansible from misinterpreting it.
- name: Deploy LVS Health Check script
  copy:
    content: |
      #!/bin/bash
      # Usage: ./check_hcip_ssh.sh <DB_IP>
      # Check if dummy0 has the HCIP via SSH
      # Added -o BatchMode=yes to ensure it never hangs waiting for a password
      ssh -q -o ConnectTimeout=2 \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o BatchMode=yes \
          root@$1 "ip addr show dummy0 | grep -q {{ hcip_value }}"
    dest: /usr/local/bin/check_hcip_ssh.sh
    mode: '0755'
  become: yes

# 5. Deploy Keepalived Configuration
- name: Deploy Keepalived configuration from template
  template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: Restart Keepalived

# 6. Ensure Keepalived is started
- name: Start and Enable Keepalived
  service:
    name: keepalived
    state: started
    enabled: yes
  become: yes
