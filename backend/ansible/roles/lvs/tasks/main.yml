---
# 1. Install Keepalived and Ipvsadm
- name: Install LVS and Keepalived dependencies
  apt:
    name:
      - keepalived
      - ipvsadm
    state: present
    update_cache: yes
  become: yes

# 2. Enable IP Forwarding (Crucial for LVS)
- name: Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  become: yes

# 3. Setup SSH for Health Checks
# The keys were generated in Phase 0; now we just deploy the private key to LVS nodes
- name: Ensure .ssh directory exists for root
  file:
    path: /root/.ssh
    state: directory
    mode: '0700'
  become: yes

- name: Deploy SSH Private Key for LVS Health Checks
  copy:
    src: id_rsa  # Ansible looks in roles/lvs/files/ by default
    dest: /root/.ssh/id_rsa
    owner: root
    group: root
    mode: '0600'
  become: yes

# 4. Routing Setup for HCIP
# Ensures the LVS nodes know how to route traffic to the Floating IP
- name: Ensure route for HCIP exists (LVS-DR routing)
  shell: "ip route add {{ hcip_value }}/32 dev {{ ansible_default_ipv4.interface }} || true"
  become: yes
  changed_when: false

# 5. Deploy Keepalived Configuration
- name: Deploy Keepalived configuration from template
  template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    owner: root
    group: root
    mode: '0644'
  become: yes
  register: lvs_config

# 6. Restart Keepalived
# Forced restart to ensure the new SSH keys and config are active
- name: Restart and Enable Keepalived
  service:
    name: keepalived
    state: restarted
    enabled: yes
  become: yes
