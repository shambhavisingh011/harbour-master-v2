---
# ===============================================================
# PHASE 0: INFRASTRUCTURE HANDSHAKE
# ===============================================================
- name: "PHASE: PRE_FLIGHT_START"
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Ensure LVS files directory exists
      file:
        path: "{{ playbook_dir }}/roles/lvs/files"
        state: directory
        mode: '0755'

    - name: Generate SSH keypair for LVS Health Checks
      openssh_keypair:
        path: "{{ playbook_dir }}/roles/lvs/files/id_rsa"
        type: rsa
        size: 4096
        force: false
      register: key_gen

# ===============================================================
# PHASE 1: OS PREPARATION
# ===============================================================
- name: "PHASE: MARIADB_PREP_START"
  hosts: all
  serial: 2
  become: yes
  tasks:
    - name: Wait for apt lock to be released
      shell: "while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;"
      timeout: 300

    - name: Install basic utilities
      apt:
        name: [curl, wget, software-properties-common, gnupg2]
        state: present
        update_cache: yes

- name: Phase 2 - Setup MariaDB Repositories
  hosts: galera, async
  become: yes
  serial: 2
  roles:
    - common

# ===============================================================
# PHASE 3: GALERA CLUSTER (The Core)
# ===============================================================
- name: "PHASE: GALERA_SETUP_START"
  hosts: galera
  become: yes
  serial: 1 
  roles:
    - galera

# ===============================================================
# PHASE 4: HIGH AVAILABILITY
# ===============================================================
- name: "PHASE: LVS_SETUP_START"
  hosts: lvs
  become: yes
  roles:
    - lvs

# ===============================================================
# PHASE 5: ASYNC REPLICATION
# ===============================================================
- name: "PHASE: ASYNC_SETUP_START"
  hosts: async
  become: yes
  roles:
    - async_replica

# ===============================================================
# PHASE 6: MONITORING STACK
# ===============================================================
- name: "PHASE: MONITORING_SETUP_START"
  hosts: all
  become: yes
  serial: 2
  roles:
    - monitoring

- name: "PHASE: DEPLOYMENT_COMPLETE"
  hosts: localhost
  connection: local
  tasks:
    - debug:
        msg: "Harbor Master Deployment Finished Successfully."
