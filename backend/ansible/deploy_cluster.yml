---
# PHASE 1: Base Preparation (OS & Repos)
- name: Phase 1 - Prepare All Nodes
  hosts: all
  serial: 2
  become: yes
  tasks:
    - name: Wait for apt lock to be released
      shell: "while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;"
      timeout: 300

    - name: Install basic utilities
      apt:
        name: [curl, wget, software-properties-common, gnupg2]
        state: present
        update_cache: yes

- name: Phase 2 - Setup MariaDB Repositories
  hosts: galera, async
  become: yes
  serial: 2
  roles:
    - common

# PHASE 3: Galera Cluster Installation & Configuration
- name: Phase 3 - Build Galera Cluster
  hosts: galera
  become: yes
  # Critical: Galera bootstrap is very RAM heavy
  serial: 1 
  roles:
    - galera

# PHASE 4: Setup High Availability (Load Balancers)
- name: Setup LVS Load Balancers
  hosts: lvs
  become: yes
  roles:
    - lvs

# PHASE 5: Setup Async Replication
- name: Configure Async Replica
  hosts: async
  become: yes
  roles:
    - async_replica

# PHASE 6: Setup Monitoring
- name: Deploy Monitoring Stack
  hosts: all
  become: yes
  serial: 2
  roles:
    - monitoring
