events {}

http {
    server {
        listen 80;

        # Route to Frontend
        location / {
            proxy_pass http://harbor-frontend:80;
            proxy_set_header Host $host;
        }

        # SSE Stream - MUST come before the general /api/ block
        location /api/logs/stream {
            proxy_pass http://harbor-backend:8000/api/logs/stream;

            # 1. Standard Proxy Headers
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Connection ""; # Important: must be empty for SSE
            
            # 2. Force No-Buffer (The "Real-Time" Switch)
            proxy_buffering off;
            proxy_cache off;
            proxy_limit_rate 0; # Ensure no speed limiting
            
            # 3. SSE Specific Headers
            proxy_set_header Cache-Control "no-cache";
            proxy_set_header X-Accel-Buffering "no"; # CRITICAL for Nginx/FastAPI SSE
            
            # 4. Persistence
            proxy_read_timeout 24h;
            proxy_send_timeout 24h;
            keepalive_timeout 24h;
            chunked_transfer_encoding on;
        }
        # General Route to Backend
        location /api/ {
            # Fixed: ensured name is 'harbor-backend'
            proxy_pass http://harbor-backend:8000/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
	    proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s; # 10 minutes
        }
    }
}
